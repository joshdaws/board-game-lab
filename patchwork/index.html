<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Patchwork</title>
<style>
:root {
  --cell: 36px;
  --gap: 2.5px;
  --pad: 4px;
  --bg: #F2F2F7;
  --card: #FFFFFF;
  --text: #1C1C1E;
  --text2: #3C3C43;
  --text3: #8E8E93;
  --gray4: #D1D1D6;
  --gray5: #E5E5EA;
  --gray6: #F2F2F7;
  --blue: #007AFF;
  --green: #34C759;
  --red: #FF3B30;
  --orange: #FF9500;
  --yellow: #FFCC00;
  --teal: #5AC8FA;
  --purple: #AF52DE;
  --pink: #FF2D55;
  --r: 14px;
  --r-lg: 20px;
  --shadow: 0 2px 10px rgba(0,0,0,0.06);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
}
@media (max-width: 400px) { :root { --cell: 32px; --gap: 2px; } }
@media (min-width: 768px) { :root { --cell: 38px; } }

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
  -webkit-font-smoothing: antialiased;
  overscroll-behavior: none;
}

#app {
  max-width: 520px;
  margin: 0 auto;
  padding: 12px 16px;
  padding-top: max(12px, env(safe-area-inset-top));
  padding-bottom: max(12px, env(safe-area-inset-bottom));
  display: flex;
  flex-direction: column;
  min-height: 100%;
}

/* ── Buttons ─── */
.pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 18px;
  border-radius: 100px;
  border: none;
  font-family: inherit;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.1s, opacity 0.15s;
  -webkit-user-select: none;
  user-select: none;
}
.pill:active { transform: scale(0.96); }
.pill-blue { background: var(--blue); color: #fff; }
.pill-blue:disabled { background: var(--gray4); }
.pill-gray { background: var(--gray5); color: var(--text); }
.pill-sm { padding: 6px 14px; font-size: 13px; }
.pill-icon {
  width: 36px; height: 36px; padding: 0;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
}

/* ── Header ─── */
.hdr {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}
.hdr-title {
  font-size: 22px;
  font-weight: 800;
  letter-spacing: -0.5px;
}
.hdr-sub {
  font-size: 13px;
  font-weight: 600;
  color: var(--text3);
}
.hdr-badge {
  font-size: 12px;
  font-weight: 700;
  padding: 3px 10px;
  border-radius: 100px;
  color: #fff;
}
.hdr-badge.p0 { background: var(--teal); }
.hdr-badge.p1 { background: var(--pink); }

/* ── Stats Row ─── */
.stats-row {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
}
.stat-card {
  flex: 1;
  background: var(--card);
  border-radius: var(--r);
  padding: 8px 10px;
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  gap: 6px;
  transition: box-shadow 0.3s;
}
.stat-card.active-p0 { box-shadow: 0 0 0 2px var(--teal), var(--shadow); }
.stat-card.active-p1 { box-shadow: 0 0 0 2px var(--pink), var(--shadow); }
.stat-avatar {
  width: 28px; height: 28px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 800; color: #fff;
  flex-shrink: 0;
}
.stat-avatar.p0 { background: var(--teal); }
.stat-avatar.p1 { background: var(--pink); }
.stat-vals { display: flex; flex-direction: column; font-size: 11px; }
.stat-name { font-weight: 700; font-size: 13px; }
.stat-detail { color: var(--text3); font-weight: 500; }

/* ── Time Track ─── */
.track-wrap {
  background: var(--card);
  border-radius: var(--r);
  padding: 10px 14px 14px;
  margin-bottom: 10px;
  box-shadow: var(--shadow);
}
.track-label { font-size: 11px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
.track-bar {
  position: relative;
  height: 6px;
  background: var(--gray5);
  border-radius: 3px;
}
.track-dot {
  position: absolute;
  top: 50%;
  width: 8px; height: 8px;
  border-radius: 50%;
  transform: translate(-50%, -50%);
}
.track-dot.income { background: var(--orange); }
.track-dot.special { background: var(--purple); }
.track-dot.claimed { background: var(--gray4); }
.track-token {
  position: absolute;
  top: 50%;
  width: 18px; height: 18px;
  border-radius: 50%;
  border: 2.5px solid #fff;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  transform: translate(-50%, -50%);
  z-index: 2;
  display: flex; align-items: center; justify-content: center;
  font-size: 9px; font-weight: 800; color: #fff;
  transition: left 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.track-token.t0 { background: var(--teal); z-index: 3; }
.track-token.t1 { background: var(--pink); }

/* ── Board ─── */
.board-section {
  display: flex;
  justify-content: center;
  margin-bottom: 10px;
}
.board-frame {
  position: relative;
  background: var(--card);
  border-radius: var(--r-lg);
  padding: 8px;
  box-shadow: var(--shadow);
  touch-action: none;
}
.board {
  display: grid;
  grid-template-columns: repeat(9, var(--cell));
  gap: var(--gap);
}
.bc {
  width: var(--cell);
  height: var(--cell);
  border-radius: 5px;
  background: var(--gray6);
  transition: background 0.15s;
  position: relative;
}
.bc .bdot {
  position: absolute; top: 3px; right: 3px;
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--orange);
  border: 1px solid rgba(255,255,255,0.7);
}
.bc.clickable { cursor: pointer; }
.bc.clickable::after {
  content: '';
  position: absolute;
  inset: 2px;
  border: 2px dashed var(--green);
  border-radius: 4px;
  opacity: 0.6;
}

/* Preview overlay */
.preview {
  position: absolute;
  pointer-events: none;
  z-index: 5;
  display: grid;
  gap: var(--gap);
  transition: transform 0.08s ease-out;
}
.preview .pc {
  width: var(--cell);
  height: var(--cell);
  border-radius: 5px;
  transition: background 0.1s;
}
.preview.valid .pc.on { background: rgba(52,199,89,0.45); box-shadow: inset 0 0 0 2px rgba(52,199,89,0.6); }
.preview.invalid .pc.on { background: rgba(255,59,48,0.3); box-shadow: inset 0 0 0 2px rgba(255,59,48,0.4); }
.preview .pc.off { /* transparent */ }

/* ── Market ─── */
.market-wrap {
  background: var(--card);
  border-radius: var(--r-lg);
  padding: 12px;
  margin-bottom: 10px;
  box-shadow: var(--shadow);
}
.market-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.market-title { font-size: 11px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; }
.market-count { font-size: 11px; color: var(--text3); }
.market-row {
  display: flex;
  gap: 10px;
  overflow-x: auto;
  padding-bottom: 4px;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
}
.mp {
  flex-shrink: 0;
  min-width: 64px;
  padding: 10px 8px 6px;
  border-radius: var(--r);
  background: var(--gray6);
  border: 2px solid transparent;
  text-align: center;
  scroll-snap-align: start;
  transition: all 0.2s;
  cursor: default;
  opacity: 0.3;
  position: relative;
}
.mp.avail {
  opacity: 1;
  background: #fff;
  border-color: var(--gray5);
  cursor: pointer;
}
.mp.avail:active { transform: scale(0.95); }
.mp.avail.cant {
  opacity: 0.45;
  cursor: not-allowed;
  border-color: transparent;
}
.mp.avail.cant:active { transform: none; }
.mp .pawn-pip {
  position: absolute; top: -6px; left: 50%; transform: translateX(-50%);
  width: 12px; height: 12px; border-radius: 50%;
  background: var(--orange); border: 2px solid #fff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}
.mshape { display: inline-grid; gap: 2px; margin-bottom: 6px; }
.mshape .ms {
  width: 12px; height: 12px;
  border-radius: 2px;
}
.mshape .ms.off { background: transparent; }
.mp-cost {
  font-size: 11px; font-weight: 600; color: var(--text2);
  white-space: nowrap;
}
.mp-income {
  display: inline-block;
  font-size: 10px; font-weight: 700;
  background: #FFF3E0; color: var(--orange);
  padding: 1px 5px; border-radius: 4px;
  margin-top: 2px;
}

/* ── Action Bar ─── */
.actions {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  padding: 4px 0;
}
.actions .msg {
  flex: 1;
  font-size: 14px;
  font-weight: 500;
  color: var(--text2);
  min-width: 120px;
}
.actions .hint {
  font-size: 12px;
  color: var(--text3);
}

/* ── Game Over ─── */
.overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.4);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  display: flex; align-items: center; justify-content: center;
  z-index: 100;
  animation: fadeIn 0.3s;
  padding: 20px;
}
@keyframes fadeIn { from { opacity: 0 } }
.over-card {
  background: var(--card);
  border-radius: var(--r-lg);
  padding: 32px;
  text-align: center;
  box-shadow: var(--shadow-lg);
  width: 100%;
  max-width: 340px;
  animation: popIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes popIn { from { transform: scale(0.85); opacity: 0 } }
.over-card h2 { font-size: 22px; font-weight: 800; margin-bottom: 4px; }
.over-sub { font-size: 14px; color: var(--text3); margin-bottom: 16px; }
.score-grid {
  display: grid;
  grid-template-columns: auto 1fr 1fr;
  gap: 4px 16px;
  font-size: 14px;
  text-align: center;
  margin-bottom: 20px;
}
.score-grid .lbl { text-align: left; color: var(--text3); font-weight: 500; }
.score-grid .total { font-weight: 800; font-size: 18px; padding-top: 6px; border-top: 1px solid var(--gray5); }

/* ── Setup ─── */
.setup {
  flex: 1;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 20px;
  text-align: center;
}
.setup-title { font-size: 36px; font-weight: 800; letter-spacing: -1px; }
.setup-sub { font-size: 15px; color: var(--text3); margin-top: -12px; }
.setup-form { width: 260px; display: flex; flex-direction: column; gap: 12px; }
.setup-form label { font-size: 12px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; text-align: left; }
.setup-form select {
  width: 100%; padding: 10px 14px;
  background: var(--card); color: var(--text);
  border: 1px solid var(--gray5);
  border-radius: var(--r);
  font-family: inherit; font-size: 15px;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%238E8E93' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 14px center;
}
.setup-form .pill { width: 100%; justify-content: center; margin-top: 4px; padding: 12px; font-size: 17px; }

/* ── Desktop layout ─── */
@media (min-width: 768px) {
  #app { max-width: 900px; }
  .desk-split { display: flex; gap: 16px; align-items: flex-start; }
  .desk-main { flex: 1; }
  .desk-side { flex: 1; }
}
</style>
</head>
<body>
<div id="app"></div>
<script type="module">
import {
  createGame, getAvailablePatches,
  findValidPlacements, canPlace,
  actionAdvance, actionBuyPatch, confirmPlacement,
  placeSpecialPatch, getScoreBreakdown, countEmpty,
  flipShape, getOrientations,
} from './engine.js';
import { BUTTON_INCOME_AFTER, SPECIAL_PATCH_AFTER } from './patches.js';
import { executeAIMove, aiPlaceSpecialPatch } from './ai.js';

/* ── Colors ───────────────────────────────────────────── */
const FC = [
  '#FF6B6B','#FFA06B','#FFD36B','#A8E06B','#6BE0A8',
  '#6BD4E0','#6BA8E0','#8B6BE0','#D46BE0','#E06B8B',
  '#FF8C94','#FFB494','#FFD894','#B8E894','#94E8C4',
  '#94DCE8','#94B8E8','#A894E8','#DC94E8','#E894B8',
  '#C97272','#C99A72','#C9C072','#8AC972','#72C9A0',
  '#72BCC9','#7296C9','#8A72C9','#BC72C9','#C97290',
  '#E8A0A0','#E8C0A0','#D8E8A0',
];
const SP_COLOR = '#B4A08C';

/* ── State ────────────────────────────────────────────── */
let game = null;
let appMode = 'setup';
let gameMode = 'vs-ai';
let aiDiff = 'medium';
let colorBoards = [null, null];

// Placement
let plPatch = null;
let plShape = null;
let plRow = 0, plCol = 0;
let plOi = 0, plOrients = [];
let plValid = false;

// Drag tracking
let dragging = false;
let dragStartX = 0, dragStartY = 0;
let didDrag = false;
let lastTapTime = 0;

// DOM refs
let boardFrameEl = null;
let previewEl = null;

const $ = document.getElementById('app');

function pColor(id) { return FC[id % FC.length]; }
function makeColorBoard() { return Array.from({length:9}, () => Array(9).fill(null)); }

/* ── DOM helper ───────────────────────────────────────── */
function h(tag, a, ...ch) {
  const e = document.createElement(tag);
  if (a) for (const [k,v] of Object.entries(a)) {
    if (k==='cls') e.className=v;
    else if (k==='style'&&typeof v==='object') Object.assign(e.style,v);
    else if (k.startsWith('on')) e[k]=v;
    else e.setAttribute(k,String(v));
  }
  for (const c of ch) {
    if (c==null||c===false) continue;
    if (typeof c==='string'||typeof c==='number') e.append(String(c));
    else if (Array.isArray(c)) c.forEach(x=>{if(x)e.append(x)});
    else e.append(c);
  }
  return e;
}

/* ── Render ────────────────────────────────────────────── */
function render() {
  $.replaceChildren();
  if (appMode==='setup') { $.append(renderSetup()); return; }
  renderGame();
}

function renderSetup() {
  const gm=h('select',null,h('option',{value:'vs-ai',selected:''},'vs AI'),h('option',{value:'local'},'2 Players'));
  const ai=h('select',null,h('option',{value:'easy'},'Easy'),h('option',{value:'medium',selected:''},'Medium'),h('option',{value:'hard'},'Hard'));
  gm.onchange=e=>{gameMode=e.target.value;ai.disabled=gameMode==='local';};
  ai.onchange=e=>{aiDiff=e.target.value;};
  const go=h('button',{cls:'pill pill-blue'},'Start Game');
  go.onclick=startGame;
  return h('div',{cls:'setup'},
    h('div',{cls:'setup-title'},'Patchwork'),
    h('p',{cls:'setup-sub'},'A quilting game for two'),
    h('div',{cls:'setup-form'},
      h('label',null,'Mode'),gm,
      h('label',null,'Difficulty'),ai,go));
}

function startGame() {
  game=createGame(); appMode='playing';
  plPatch=null; plShape=null;
  colorBoards=[makeColorBoard(),makeColorBoard()];
  render();
}

function renderGame() {
  $.replaceChildren();
  const act=game.currentPlayer;
  const isAI=gameMode==='vs-ai'&&act===1;
  const name=i=>(gameMode==='vs-ai'&&i===1)?'AI':`P${i+1}`;

  // Header
  const badge=h('span',{cls:`hdr-badge p${act}`},
    game.phase==='game_over'?'Done':`${name(act)}'s turn`);
  const newBtn=h('button',{cls:'pill pill-gray pill-sm',onclick:()=>{appMode='setup';render();}},'New');
  $.append(h('div',{cls:'hdr'},
    h('div',null,h('span',{cls:'hdr-title'},'Patchwork'),' ',badge),newBtn));

  // Stats
  const sr=h('div',{cls:'stats-row'});
  for (let i=0;i<2;i++) {
    const p=game.players[i];
    const emp=countEmpty(p.board);
    let cls='stat-card';
    if (act===i) cls+=` active-p${i}`;
    sr.append(h('div',{cls},
      h('div',{cls:`stat-avatar p${i}`},name(i)),
      h('div',{cls:'stat-vals'},
        h('div',{cls:'stat-name'},`${p.buttons} buttons`),
        h('div',{cls:'stat-detail'},`+${p.totalButtonIncome}/trig  ${emp} empty${p.hasSpecialTile?' | 7x7!':''}`))));
  }
  $.append(sr);

  // Time track
  $.append(buildTrack());

  // Board(s) - show active player's board, and opponent smaller on desktop
  const isWide = window.innerWidth >= 768;
  if (isWide) {
    const split = h('div',{cls:'desk-split'});
    split.append(h('div',{cls:'desk-main'},buildBoardSection(act)));
    split.append(h('div',{cls:'desk-side'},buildBoardSection(1-act, true)));
    $.append(split);
  } else {
    $.append(buildBoardSection(act));
  }

  // Market
  $.append(buildMarket());

  // Actions
  $.append(buildActions());

  // Game over
  if (game.phase==='game_over') $.append(buildGameOver());

  // AI
  if (isAI && game.phase!=='game_over') setTimeout(doAITurn,450);
}

/* ── Track ──────────────────────────────────────────── */
function buildTrack() {
  const bar=h('div',{cls:'track-bar'});
  const pct=i=>`${(i/52)*100}%`;

  // Income & special dots
  for (const p of BUTTON_INCOME_AFTER) {
    bar.append(h('div',{cls:'track-dot income',style:{left:pct(p)}}));
  }
  for (const p of SPECIAL_PATCH_AFTER) {
    const claimed=game.specialPatchesClaimed.includes(p);
    bar.append(h('div',{cls:`track-dot ${claimed?'claimed':'special'}`,style:{left:pct(p)}}));
  }

  // Player tokens
  for (let i=0;i<2;i++) {
    const pos=game.players[i].timePosition;
    bar.append(h('div',{cls:`track-token t${i}`,style:{left:pct(pos)}},String(i+1)));
  }

  return h('div',{cls:'track-wrap'},h('div',{cls:'track-label'},'Time Track'),bar);
}

/* ── Board ──────────────────────────────────────────── */
function buildBoardSection(idx, small) {
  const p=game.players[idx];
  const cb=colorBoards[idx];
  const isPlacing=(game.phase==='place_patch'||game.phase==='place_special')&&game.currentPlayer===idx;

  const board=h('div',{cls:'board'});
  if (small) board.style.setProperty('--cell','28px');

  for (let r=0;r<9;r++) {
    for (let c=0;c<9;c++) {
      const filled=p.board[r][c];
      const cc=cb?cb[r][c]:null;
      const cell=h('div',{cls:'bc'});

      if (filled) {
        const color = cc ? (cc.endsWith('!') ? cc.slice(0,-1) : cc) : '#C7C7CC';
        cell.style.background=color;
        if (cc && cc.endsWith('!')) cell.append(h('div',{cls:'bdot'}));
      }

      // Special patch clickable
      if (game.phase==='place_special' && game.currentPlayer===idx && !filled) {
        cell.classList.add('clickable');
        cell.onclick=()=>doPlaceSpecial(r,c);
      }

      board.append(cell);
    }
  }

  const frame=h('div',{cls:'board-frame'},board);

  // Add preview overlay during placement
  if (isPlacing && plShape && game.phase==='place_patch' && !small) {
    const prev=buildPreview();
    frame.append(prev);
    // Store refs for drag updates
    boardFrameEl=frame;
    previewEl=prev;

    // Attach pointer events for drag
    frame.onpointerdown=onPointerDown;
    frame.onpointermove=onPointerMove;
    frame.onpointerup=onPointerUp;
    frame.onpointercancel=onPointerUp;
  } else {
    boardFrameEl=null;
    previewEl=null;
  }

  const name=(gameMode==='vs-ai'&&idx===1)?'AI':`Player ${idx+1}`;
  const label=small ? h('div',{style:{fontSize:'12px',fontWeight:'700',color:'var(--text3)',marginBottom:'6px',textAlign:'center'}},name) : null;

  return h('div',{cls:'board-section',style:{flexDirection:'column',alignItems:'center'}},label,frame);
}

function buildPreview() {
  const cols=plShape[0].length;
  const g=h('div',{cls:`preview ${plValid?'valid':'invalid'}`,
    style:{gridTemplateColumns:`repeat(${cols}, var(--cell))`,
      padding:'8px', /* match board-frame padding */
    }});

  for (const row of plShape) {
    for (const v of row) {
      g.append(h('div',{cls:`pc ${v>=1?'on':'off'}`}));
    }
  }

  // Position it using CSS custom properties
  updatePreviewPosition(g);
  return g;
}

function updatePreviewPosition(el) {
  const cellPx = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell'));
  const gapPx = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap'));
  const step = cellPx + gapPx;
  (el||previewEl).style.transform = `translate(${plCol*step}px, ${plRow*step}px)`;
}

/* ── Drag / Tap ────────────────────────────────────────── */
function onPointerDown(e) {
  if (game.phase!=='place_patch') return;
  dragging=true;
  didDrag=false;
  dragStartX=e.clientX;
  dragStartY=e.clientY;
  e.currentTarget.setPointerCapture(e.pointerId);
  e.preventDefault();
}

function onPointerMove(e) {
  if (!dragging) return;
  const dx=e.clientX-dragStartX, dy=e.clientY-dragStartY;
  if (Math.abs(dx)>6||Math.abs(dy)>6) didDrag=true;
  if (!didDrag) return;

  // Calculate grid position from pointer
  const rect=boardFrameEl.querySelector('.board').getBoundingClientRect();
  const cellPx=rect.width/9; // approximate cell+gap
  const x=e.clientX-rect.left;
  const y=e.clientY-rect.top;

  // Center the shape on the pointer
  const rows=plShape.length, cols=plShape[0].length;
  let nc=Math.round(x/cellPx - cols/2);
  let nr=Math.round(y/cellPx - rows/2);
  nc=Math.max(0,Math.min(9-cols,nc));
  nr=Math.max(0,Math.min(9-rows,nr));

  if (nr!==plRow || nc!==plCol) {
    plRow=nr; plCol=nc;
    plValid=canPlace(game.players[game.currentPlayer].board,plShape,plRow,plCol);
    if (previewEl) {
      updatePreviewPosition();
      previewEl.className=`preview ${plValid?'valid':'invalid'}`;
    }
  }
}

function onPointerUp(e) {
  if (!dragging) return;
  dragging=false;

  if (!didDrag) {
    // It was a tap
    const now=Date.now();
    if (now-lastTapTime<400 && plValid) {
      // Double tap → place
      lastTapTime=0;
      doConfirm();
      return;
    }
    lastTapTime=now;
    // Single tap → rotate
    doRotate();
    return;
  }
  // Drag ended — position is set, user can tap Place or double-tap
}

/* ── Market ─────────────────────────────────────────── */
function buildMarket() {
  const available=getAvailablePatches(game);
  const availSet=new Set(available.map(a=>a.marketIndex));
  const player=game.players[game.currentPlayer];
  const len=game.patches.length;

  const row=h('div',{cls:'market-row'});
  const show=Math.min(len,12);

  for (let off=0;off<show;off++) {
    const idx=(game.pawnIndex+off)%len;
    const patch=game.patches[idx];
    const isAv=availSet.has(idx);
    const isPawn=off===0;
    const afford=player.buttons>=patch.buttonCost;
    const fits=isAv&&afford?findValidPlacements(player.board,patch.shape).length>0:false;
    const col=pColor(patch.id);

    let cls='mp';
    if (isAv) { cls+=' avail'; if (!afford||!fits) cls+=' cant'; }

    const cols2=patch.shape[0].length;
    const sg=h('div',{cls:'mshape',style:{gridTemplateColumns:`repeat(${cols2},12px)`}});
    for (const r of patch.shape) {
      for (const v of r) {
        if (v===0) sg.append(h('div',{cls:'ms off'}));
        else {
          const mc=h('div',{cls:'ms',style:{background:v===2?darken(col,20):col}});
          sg.append(mc);
        }
      }
    }

    const info=h('div',{cls:'mp-cost'},`${patch.buttonCost}b  ${patch.timeCost}t`);
    const mp=h('div',{cls},sg,info);
    if (patch.buttonIncome>0) mp.append(h('div',{cls:'mp-income'},`+${patch.buttonIncome}`));
    if (isPawn) mp.append(h('div',{cls:'pawn-pip'}));

    if (isAv&&afford&&fits) {
      mp.onclick=()=>{
        if (game.phase!=='choose_action') return;
        if (gameMode==='vs-ai'&&game.currentPlayer===1) return;
        doBuyPatch(idx);
      };
    }
    row.append(mp);
  }

  return h('div',{cls:'market-wrap'},
    h('div',{cls:'market-head'},
      h('span',{cls:'market-title'},'Patches'),
      h('span',{cls:'market-count'},`${len} left`)),
    row);
}

function darken(hex,n) {
  const v=parseInt(hex.slice(1),16);
  const r=Math.max(0,((v>>16)&255)-n);
  const g=Math.max(0,((v>>8)&255)-n);
  const b=Math.max(0,(v&255)-n);
  return `rgb(${r},${g},${b})`;
}

/* ── Actions ────────────────────────────────────────── */
function buildActions() {
  const act=game.currentPlayer;
  const isAI=gameMode==='vs-ai'&&act===1;
  const nm=isAI?'AI':`Player ${act+1}`;

  const bar=h('div',{cls:'actions'});

  if (game.phase==='game_over') {
    bar.append(h('div',{cls:'msg'},'Game over!'));
    return bar;
  }

  if (game.phase==='place_special') {
    bar.append(h('div',{cls:'msg'},isAI?'AI placing bonus patch...':'Tap an empty cell for your free patch'));
    return bar;
  }

  if (game.phase==='place_patch') {
    bar.append(h('div',{cls:'msg'},'Drag to move. Tap to rotate.'));

    const rb=h('button',{cls:'pill pill-gray pill-sm'},'Rotate');
    rb.onclick=doRotate;
    const fb=h('button',{cls:'pill pill-gray pill-sm'},'Flip');
    fb.onclick=doFlip;
    const cb=h('button',{cls:'pill pill-blue pill-sm'},'Place');
    cb.onclick=doConfirm;
    if (!plValid) cb.disabled=true;

    bar.append(rb,fb,cb);
    bar.append(h('div',{cls:'hint'},'or double-tap'));
    return bar;
  }

  if (isAI) {
    bar.append(h('div',{cls:'msg'},'AI thinking...'));
    return bar;
  }

  const opp=game.players[1-act];
  const me=game.players[act];
  const adv=Math.max(1,Math.min(opp.timePosition+1,52)-me.timePosition);

  bar.append(h('div',{cls:'msg'},'Buy a patch or'));
  const ab=h('button',{cls:'pill pill-blue'},`Advance +${adv}`);
  ab.onclick=doAdvance;
  bar.append(ab);
  return bar;
}

/* ── Game Over ──────────────────────────────────────── */
function buildGameOver() {
  const s0=getScoreBreakdown(game.players[0]);
  const s1=getScoreBreakdown(game.players[1]);
  const n0='Player 1', n1=gameMode==='vs-ai'?'AI':'Player 2';
  const winner=game.winner===0?n0:n1;

  const grid=h('div',{cls:'score-grid'},
    h('div'),h('div',{style:{fontWeight:'700'}},n0),h('div',{style:{fontWeight:'700'}},n1),
    h('div',{cls:'lbl'},'Buttons'),h('div',null,String(s0.buttons)),h('div',null,String(s1.buttons)),
    h('div',{cls:'lbl'},'7x7 Bonus'),h('div',null,`+${s0.specialTileBonus}`),h('div',null,`+${s1.specialTileBonus}`),
    h('div',{cls:'lbl'},'Penalty'),h('div',null,`-${s0.emptyPenalty}`),h('div',null,`-${s1.emptyPenalty}`),
    h('div',{cls:'lbl total'},'Score'),h('div',{cls:'total'},String(s0.total)),h('div',{cls:'total'},String(s1.total)));

  const btn=h('button',{cls:'pill pill-blue',style:{width:'100%',justifyContent:'center',marginTop:'4px',padding:'14px',fontSize:'17px'}},'Play Again');
  btn.onclick=startGame;

  return h('div',{cls:'overlay'},
    h('div',{cls:'over-card'},
      h('h2',null,`${winner} Wins!`),
      h('div',{cls:'over-sub'},'Final Scores'),
      grid,btn));
}

/* ── Game Actions ─────────────────────────────────────── */
function doAdvance() {
  if (game.phase!=='choose_action') return;
  actionAdvance(game);
  afterTurn();
}

function doBuyPatch(marketIndex) {
  if (game.phase!=='choose_action') return;
  const player=game.players[game.currentPlayer];
  const patch=game.patches[marketIndex];
  if (player.buttons<patch.buttonCost) return;
  if (findValidPlacements(player.board,patch.shape).length===0) return;

  const result=actionBuyPatch(game,marketIndex);
  if (result.error) return;

  plPatch=result.patch;
  plOrients=getOrientations(result.patch.shape);
  plOi=0;
  plShape=plOrients[0];
  // Start centered
  plRow=Math.floor((9-plShape.length)/2);
  plCol=Math.floor((9-plShape[0].length)/2);
  plValid=canPlace(player.board,plShape,plRow,plCol);
  lastTapTime=0;
  render();
}

function doRotate() {
  if (!plOrients.length) return;
  plOi=(plOi+1)%plOrients.length;
  plShape=plOrients[plOi];
  // Clamp position
  plRow=Math.min(plRow,9-plShape.length);
  plCol=Math.min(plCol,9-plShape[0].length);
  plValid=canPlace(game.players[game.currentPlayer].board,plShape,plRow,plCol);
  render();
}

function doFlip() {
  const f=flipShape(plShape);
  const key=JSON.stringify(f);
  const idx=plOrients.findIndex(o=>JSON.stringify(o)===key);
  if (idx>=0){plOi=idx;plShape=plOrients[idx];}
  else{plOi=(plOi+4)%plOrients.length;plShape=plOrients[plOi];}
  plRow=Math.min(plRow,9-plShape.length);
  plCol=Math.min(plCol,9-plShape[0].length);
  plValid=canPlace(game.players[game.currentPlayer].board,plShape,plRow,plCol);
  render();
}

function doConfirm() {
  if (!plValid||!plPatch) return;
  const pi=game.currentPlayer;
  const col=pColor(plPatch.id);
  for (let r=0;r<plShape.length;r++)
    for (let c=0;c<plShape[0].length;c++)
      if (plShape[r][c]>=1)
        colorBoards[pi][plRow+r][plCol+c]=plShape[r][c]===2?col+'!':col;

  confirmPlacement(game,plShape,plRow,plCol);
  plPatch=null; plShape=null;
  afterTurn();
}

function doPlaceSpecial(r,c) {
  const pi=game.currentPlayer;
  const result=placeSpecialPatch(game,r,c);
  if (result.error) return;
  colorBoards[pi][r][c]=SP_COLOR;
  afterTurn();
}

function afterTurn() {
  if (game.phase==='place_special'&&gameMode==='vs-ai'&&game.currentPlayer===1) {
    while(game.pendingSpecials&&game.pendingSpecials.length>0) {
      const pos=aiPlaceSpecialPatch(game);
      colorBoards[1][pos.row][pos.col]=SP_COLOR;
      placeSpecialPatch(game,pos.row,pos.col);
    }
  }
  render();
}

function doAITurn() {
  if (game.phase==='game_over') return;
  if (game.phase==='place_special') {
    while(game.pendingSpecials&&game.pendingSpecials.length>0) {
      const pos=aiPlaceSpecialPatch(game);
      colorBoards[1][pos.row][pos.col]=SP_COLOR;
      placeSpecialPatch(game,pos.row,pos.col);
    }
    render();
    if (game.currentPlayer===1&&game.phase==='choose_action') setTimeout(doAITurn,450);
    return;
  }
  if (game.phase!=='choose_action'||game.currentPlayer!==1) return;

  const before=game.players[1].board.map(r=>[...r]);
  const {move}=executeAIMove(game,aiDiff);

  if (move.action==='buy'&&move.placement) {
    for (let r=0;r<9;r++)
      for (let c=0;c<9;c++)
        if (game.players[1].board[r][c]&&!before[r][c]) {
          const sr=r-move.placement.row, sc=c-move.placement.col;
          let isInc=false;
          if (sr>=0&&sr<move.placement.shape.length&&sc>=0&&sc<move.placement.shape[0].length)
            isInc=move.placement.shape[sr][sc]===2;
          const ac=FC[(game.patches.length+r+c)%FC.length];
          colorBoards[1][r][c]=isInc?ac+'!':ac;
        }
  }

  if (game.phase==='place_special') {
    while(game.pendingSpecials&&game.pendingSpecials.length>0) {
      const pos=aiPlaceSpecialPatch(game);
      colorBoards[1][pos.row][pos.col]=SP_COLOR;
      placeSpecialPatch(game,pos.row,pos.col);
    }
  }
  render();
  if (game.currentPlayer===1&&game.phase==='choose_action') setTimeout(doAITurn,450);
}

/* ── Keyboard ──────────────────────────────────────── */
document.addEventListener('keydown',e=>{
  if (appMode!=='playing'||game.phase!=='place_patch') return;
  const cellPx=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell'));
  const gapPx=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap'));
  switch(e.key.toLowerCase()) {
    case 'r': doRotate(); break;
    case 'f': doFlip(); break;
    case 'enter': doConfirm(); break;
    case 'arrowleft': e.preventDefault(); plCol=Math.max(0,plCol-1); plValid=canPlace(game.players[game.currentPlayer].board,plShape,plRow,plCol); render(); break;
    case 'arrowright': e.preventDefault(); plCol=Math.min(9-plShape[0].length,plCol+1); plValid=canPlace(game.players[game.currentPlayer].board,plShape,plRow,plCol); render(); break;
    case 'arrowup': e.preventDefault(); plRow=Math.max(0,plRow-1); plValid=canPlace(game.players[game.currentPlayer].board,plShape,plRow,plCol); render(); break;
    case 'arrowdown': e.preventDefault(); plRow=Math.min(9-plShape.length,plRow+1); plValid=canPlace(game.players[game.currentPlayer].board,plShape,plRow,plCol); render(); break;
  }
});

/* ── Init ──────────────────────────────────────────── */
render();
</script>
</body>
</html>
